<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes D√©chets - MEL | Monitoring PAV</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --mel-blue: #004191;
            --mel-light: #f4f7fa;
            --green: #27ae60;
            --red: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--mel-light);
        }

        /* En-t√™te style Institutionnel */
        header {
            background-color: var(--mel-blue);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        header h1 { margin: 0; font-size: 1.1rem; text-transform: uppercase; }

        /* Panneau de contr√¥le */
        #ui-panel {
            background: white;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-bottom: 1px solid #ddd;
        }

        select, button {
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        button {
            background-color: var(--mel-blue);
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }

        button:hover { opacity: 0.9; }

        /* Carte */
        #map { flex-grow: 1; width: 100%; }

        /* Console de Diagnostic (Debug) */
        #debug-console {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            border-radius: 5px;
            max-height: 80px;
            overflow-y: auto;
            z-index: 9999;
            pointer-events: none; /* Ne g√™ne pas le clic sur la carte */
        }

        /* Tooltip style */
        .status-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<header>
    <h1>Points d'Apport Volontaire - M√©tropole Europ√©enne de Lille</h1>
</header>

<div id="ui-panel">
    <label for="typeDechet">Que souhaitez-vous recycler ?</label>
    <select id="typeDechet">
        <option value="VERRE">Verre</option>
        <option value="PAPIER">Papier / Carton</option>
        <option value="TEXTILE">Textile</option>
    </select>
    <button onclick="trouverLePlusProche()">Trouver le point disponible le plus proche</button>
</div>

<div id="map"></div>
<div id="debug-console">Initialisation du syst√®me...</div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://data.lillemetropole.fr/api/records/1.0/search/?dataset=points-d-apport-volontaire-pav&rows=150";
    const userPos = [50.6333, 3.0667]; // Position de test (Lille Centre)

    // --- INITIALISATION CARTE ---
    const map = L.map('map').setView(userPos, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);

    // Marqueur Utilisateur
    L.marker(userPos, {icon: L.divIcon({className: '', html: 'üìç', iconSize: [30, 30]})})
     .addTo(map).bindPopup("<b>Ma position actuelle</b>");

    let allPavs = [];

    // Fonction de debug visuelle
    function log(msg) {
        const consoleEl = document.getElementById('debug-console');
        consoleEl.innerHTML += `<br>> ${msg}`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
        console.log(msg);
    }

    // --- CHARGEMENT DES DONN√âES ---
    async function fetchPavData() {
        log("Tentative de connexion √† Lille Open Data...");
        
        try {
            // Tentative 1 : Directe
            let response = await fetch(API_URL);
            
            if (!response.ok) {
                log("Connexion directe √©chou√©e. Tentative via Proxy...");
                // Tentative 2 : Via Proxy si le direct √©choue (CORS)
                response = await fetch("https://corsproxy.io/?" + encodeURIComponent(API_URL));
            }

            const data = await response.json();
            
            if (!data.records) throw new Error("Format de donn√©es invalide");

            allPavs = data.records.map(r => ({
                adresse: r.fields.adresse || "Adresse non sp√©cifi√©e",
                commune: r.fields.commune || "Lille",
                flux: r.fields.flux || "Inconnu",
                coords: r.fields.geo_point_2d,
                estPlein: Math.random() > 0.7 // Simulation : 30% de chance d'√™tre plein
            }));

            log(`R√©cup√©ration r√©ussie : ${allPavs.length} PAV trouv√©s.`);
            displayMarkers(allPavs);

        } catch (error) {
            log(`ERREUR CRITIQUE : ${error.message}`);
            log("Chargement des donn√©es de secours...");
            loadFallbackData();
        }
    }

    function loadFallbackData() {
        allPavs = [
            { adresse: "Grand Place", commune: "LILLE", flux: "VERRE", coords: [50.637, 3.063], estPlein: false },
            { adresse: "Gare Lille Flandres", commune: "LILLE", flux: "PAPIER", coords: [50.636, 3.070], estPlein: true },
            { adresse: "Parc Jean-Baptiste Lebas", commune: "LILLE", flux: "TEXTILE", coords: [50.627, 3.066], estPlein: false }
        ];
        displayMarkers(allPavs);
    }

    // --- AFFICHAGE ---
    function displayMarkers(list) {
        list.forEach(pav => {
            const color = pav.estPlein ? 'var(--red)' : 'var(--green)';
            const statusLabel = pav.estPlein ? 'PLEIN' : 'DISPONIBLE';

            const marker = L.circleMarker(pav.coords, {
                radius: 8,
                fillColor: color,
                color: "#fff",
                weight: 2,
                fillOpacity: 0.9
            }).addTo(map);

            marker.bindPopup(`
                <strong>Flux : ${pav.flux}</strong><br>
                ${pav.adresse}<br>
                <div class="status-tag" style="background:${color}">${statusLabel}</div>
            `);
        });
    }

    // --- RECHERCHE ---
    function trouverLePlusProche() {
        const type = document.getElementById('typeDechet').value;
        log(`Recherche du PAV ${type} disponible...`);

        // Filtrage
        const candidates = allPavs.filter(p => 
            p.flux.toUpperCase().includes(type) && !p.estPlein
        );

        if (candidates.length === 0) {
            alert("Aucun PAV de ce type n'est disponible actuellement (tous sont pleins ou aucun n'a √©t√© trouv√©).");
            return;
        }

        // Tri par distance (Haversine simplifi√©e)
        candidates.sort((a, b) => {
            const d1 = Math.hypot(a.coords[0] - userPos[0], a.coords[1] - userPos[1]);
            const d2 = Math.hypot(b.coords[0] - userPos[0], b.coords[1] - userPos[1]);
            return d1 - d2;
        });

        const nearest = candidates[0];
        log(`Trouv√© : ${nearest.adresse}`);
        
        map.flyTo(nearest.coords, 17, { duration: 1.5 });
        
        // Ouvrir la popup automatiquement apr√®s le d√©placement
        setTimeout(() => {
            L.popup()
                .setLatLng(nearest.coords)
                .setContent(`<b>Le plus proche !</b><br>${nearest.adresse}<br>Statut: DISPONIBLE`)
                .openOn(map);
        }, 1600);
    }

    // Lancement
    window.onload = fetchPavData;
</script>

</body>
</html>
