<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAV MEL - Scanner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --mel-blue: #004191; --green: #27ae60; --red: #e74c3c; }
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: var(--mel-blue); color: white; padding: 10px; text-align: center; font-weight: bold; }
        #controls { padding: 15px; border-bottom: 2px solid #ddd; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; }
        #map { flex-grow: 1; }
        button { background: var(--mel-blue); color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #debug-box { position: fixed; bottom: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; font-family: monospace; font-size: 10px; max-height: 100px; overflow-y: auto; z-index: 2000; display: none; }
        .status-pill { padding: 2px 6px; border-radius: 10px; color: white; font-size: 0.7rem; }
    </style>
</head>
<body>

<header>PROJET MEL - GESTION DES DÉCHETS</header>

<div id="controls">
    <label>Déchet à recycler :</label>
    <select id="typeDechet">
        <option value="VERRE">Verre</option>
        <option value="PAPIER">Papier / Carton</option>
        <option value="TEXTILE">Textile</option>
    </select>
    <button onclick="trouverLePlusProche()">Trouver le point disponible le plus proche</button>
</div>

<div id="map"></div>
<div id="debug-box" id="debug"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const debug = (msg) => {
        const box = document.getElementById('debug-box');
        box.style.display = 'block';
        box.innerHTML += `> ${msg}<br>`;
        console.log(msg);
    };

    // Configuration
    const API_URL = "https://data.lillemetropole.fr/api/explore/v2.1/catalog/datasets/points-d-apport-volontaire-pav/records?limit=100";
    const PROXY = "https://api.allorigins.win/raw?url=";
    
    const map = L.map('map').setView([50.63, 3.06], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let allPavs = [];
    const userPos = [50.633, 3.060]; // Simulation Lille Centre

    // Marqueur utilisateur
    L.marker(userPos).addTo(map).bindPopup("<b>Ma position</b>");

    async function chargerDonnees() {
        debug("Tentative de chargement via Proxy Raw...");
        try {
            const response = await fetch(PROXY + encodeURIComponent(API_URL));
            
            if (!response.ok) throw new Error("Réponse serveur : " + response.status);
            
            const data = await response.json();
            // Dans l'API v2.1, les données sont dans 'results'
            const records = data.results || data.records; 
            
            if (!records) throw new Error("Format de données inconnu");

            allPavs = records.map(r => ({
                adresse: r.adresse || r.fields?.adresse,
                flux: r.flux || r.fields?.flux,
                coords: r.geo_point_2d || r.fields?.geo_point_2d,
                estPlein: Math.random() > 0.7 // Simulation
            }));

            debug(`Succès : ${allPavs.length} points chargés.`);
            afficherMarkers();
        } catch (err) {
            debug("ERREUR : " + err.message);
            chargerDonneesDeSecours();
        }
    }

    function chargerDonneesDeSecours() {
        debug("Chargement des données de secours locales...");
        allPavs = [
            { adresse: "Grand Place", flux: "VERRE", coords: [50.637, 3.063], estPlein: false },
            { adresse: "Rue Nationale", flux: "PAPIER", coords: [50.635, 3.058], estPlein: true },
            { adresse: "Gare Flandres", flux: "VERRE", coords: [50.636, 3.070], estPlein: false }
        ];
        afficherMarkers();
    }

    function afficherMarkers() {
        allPavs.forEach(pav => {
            const color = pav.estPlein ? '#e74c3c' : '#27ae60';
            L.circleMarker(pav.coords, {
                radius: 8, fillColor: color, color: "#fff", weight: 2, fillOpacity: 0.9
            }).addTo(map).bindPopup(`
                <b>${pav.flux}</b><br>${pav.adresse}<br>
                <span style="color:${color}">● ${pav.estPlein ? 'PLEIN' : 'DISPONIBLE'}</span>
            `);
        });
    }

    function trouverLePlusProche() {
        const type = document.getElementById('typeDechet').value;
        const dispos = allPavs.filter(p => p.flux.includes(type) && !p.estPlein);

        if (dispos.length === 0) {
            alert("Aucun point disponible pour ce type.");
            return;
        }

        dispos.sort((a, b) => {
            const d1 = Math.hypot(a.coords[0]-userPos[0], a.coords[1]-userPos[1]);
            const d2 = Math.hypot(b.coords[0]-userPos[0], b.coords[1]-userPos[1]);
            return d1 - d2;
        });

        const cible = dispos[0];
        map.flyTo(cible.coords, 16);
        debug(`Navigation vers : ${cible.adresse}`);
    }

    window.onload = chargerDonnees;
</script>

</body>
</html>
